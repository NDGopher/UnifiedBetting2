<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Live Odds Dashboard</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; background: #0f1216; color: #e7e7e7; margin: 0; }
      header { padding: 12px 16px; border-bottom: 1px solid #222; display: flex; align-items: center; justify-content: space-between; }
      .tag { background: #1f2430; color: #b5cfff; padding: 2px 6px; border-radius: 6px; font-size: 12px; }
      table { width: 100%; border-collapse: collapse; table-layout: fixed; }
      th, td { padding: 10px 12px; border-bottom: 1px solid #1f2430; font-size: 12px; vertical-align: middle; }
      tbody tr:nth-child(odd) { background: #0f1319; }
      tbody tr:nth-child(even) { background: #111722; }
      th { position: sticky; top: 0; background: #12161c; z-index: 1; text-align: left; }
      tr:hover { background: #182030; }
      .mono { font-family: ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
      .container { padding: 10px 14px; }
      .section-title { margin: 14px 0 6px; font-size: 14px; color: #aab4c4; }
      .matchup { display: flex; flex-direction: column; gap: 6px; }
      .row2 { display: flex; flex-direction: column; gap: 4px; }
      .line { display: flex; align-items: baseline; gap: 8px; }
      .team { font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 520px; }
      .sub { color: #98a2b3; font-size: 11px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
      .book-head { display: flex; align-items: center; justify-content: center; }
      .book-head img { width: 18px; height: 18px; opacity: 0.95; display: block; }
      th.book, td.book { text-align: center; width: 90px; }
      th.matchup, td.matchup { width: 560px; }
      .cell-odds { display: flex; flex-direction: column; line-height: 1.2; gap: 4px; }
      .highlight { background: rgba(116,255,126,0.08); border-radius: 6px; }
      .fade-enter { transition: background-color 200ms ease; }
    </style>
  </head>
  <body>
    <header>
      <div>
        <strong>Live Odds Dashboard</strong>
        <span id="activeSel" class="tag" style="margin-left:8px;">Active: -</span>
      </div>
      <div style="display:flex; gap:8px; align-items:center;">
        <button id="btn-change" class="tag" title="Change selections">Change</button>
        <button id="btn-chrome" class="tag" title="Open link(s) in Chrome">Open in Chrome</button>
        <button id="btn-firefox" class="tag" title="Open link(s) in Firefox">Open in Firefox</button>
        <button id="btn-comet" class="tag" title="Open link(s) in Comet">Open in Comet</button>
        <span class="tag">Live via WebSocket</span>
      </div>
    </header>
    <div class="container">
      <div class="section-title">ML</div>
      <table id="tbl-moneyline">
        <thead>
          <tr>
            <th class="matchup">Matchup</th>
            <th>Best</th>
            <th>Average</th>
            <th class="book"><div class="book-head"><span style="font-size:12px;color:#cbd5e1;">BetBCK</span></div></th>
            <th class="book"><div class="book-head"><img src="book_icons/fanduel.png" alt="FanDuel" title="FanDuel"/></div></th>
            <th class="book"><div class="book-head"><img src="book_icons/mgm.png" alt="BetMGM" title="BetMGM"/></div></th>
            <th class="book"><div class="book-head"><img src="book_icons/draftkings.png" alt="DraftKings" title="DraftKings"/></div></th>
            <th class="book"><div class="book-head"><img src="book_icons/caesars.png" alt="Caesars" title="Caesars"/></div></th>
            <th class="book"><div class="book-head"><img src="book_icons/espnbet.png" alt="ESPNBet" title="ESPNBet"/></div></th>
            <th class="book"><div class="book-head"><img src="book_icons/pinnacle.png" alt="Pinnacle" title="Pinnacle"/></div></th>
            <th class="book"><div class="book-head"><img src="book_icons/bet365.png" alt="BetOnline" title="BetOnline"/></div></th>
            <th class="book"><div class="book-head"><img src="book_icons/betrivers.png" alt="BetRivers" title="BetRivers"/></div></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="section-title" style="margin-top:18px;">Spread</div>
      <table id="tbl-spread">
        <thead>
          <tr>
            <th class="matchup">Matchup</th>
            <th>Best</th>
            <th>Average</th>
            <th class="book"><div class="book-head"><span style="font-size:12px;color:#cbd5e1;">BetBCK</span></div></th>
            <th class="book"><div class="book-head"><img src="book_icons/fanduel.png" alt="FanDuel" title="FanDuel"/></div></th>
            <th class="book"><div class="book-head"><img src="book_icons/mgm.png" alt="BetMGM" title="BetMGM"/></div></th>
            <th class="book"><div class="book-head"><img src="book_icons/draftkings.png" alt="DraftKings" title="DraftKings"/></div></th>
            <th class="book"><div class="book-head"><img src="book_icons/caesars.png" alt="Caesars" title="Caesars"/></div></th>
            <th class="book"><div class="book-head"><img src="book_icons/espnbet.png" alt="ESPNBet" title="ESPNBet"/></div></th>
            <th class="book"><div class="book-head"><img src="book_icons/pinnacle.png" alt="Pinnacle" title="Pinnacle"/></div></th>
            <th class="book"><div class="book-head"><img src="book_icons/bet365.png" alt="BetOnline" title="BetOnline"/></div></th>
            <th class="book"><div class="book-head"><img src="book_icons/betrivers.png" alt="BetRivers" title="BetRivers"/></div></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="section-title" style="margin-top:18px;">Total</div>
      <table id="tbl-total">
        <thead>
          <tr>
            <th class="matchup">Matchup</th>
            <th>Best</th>
            <th>Average</th>
            <th class="book"><div class="book-head"><span style="font-size:12px;color:#cbd5e1;">BetBCK</span></div></th>
            <th class="book"><div class="book-head"><img src="book_icons/fanduel.png" alt="FanDuel" title="FanDuel"/></div></th>
            <th class="book"><div class="book-head"><img src="book_icons/mgm.png" alt="BetMGM" title="BetMGM"/></div></th>
            <th class="book"><div class="book-head"><img src="book_icons/draftkings.png" alt="DraftKings" title="DraftKings"/></div></th>
            <th class="book"><div class="book-head"><img src="book_icons/caesars.png" alt="Caesars" title="Caesars"/></div></th>
            <th class="book"><div class="book-head"><img src="book_icons/espnbet.png" alt="ESPNBet" title="ESPNBet"/></div></th>
            <th class="book"><div class="book-head"><img src="book_icons/pinnacle.png" alt="Pinnacle" title="Pinnacle"/></div></th>
            <th class="book"><div class="book-head"><img src="book_icons/bet365.png" alt="BetOnline" title="BetOnline"/></div></th>
            <th class="book"><div class="book-head"><img src="book_icons/betrivers.png" alt="BetRivers" title="BetRivers"/></div></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <script>
      const booksOrder = ["betbck","fanduel","betmgm","draftkings","caesars","espnbet","pinnacle","betonline","betrivers"];

      function groupByMatchup(rows, market) {
        const groups = new Map();
        (rows||[]).filter(r => (r.market||'').toLowerCase().includes(market)).forEach(r => {
          const a = (r.team||'').toLowerCase();
          const b = (r.opponent||'').toLowerCase();
          const key = a < b ? `${a}|${b}|${market}|${r.line||''}` : `${b}|${a}|${market}|${r.line||''}`;
          if (!groups.has(key)) groups.set(key, []);
          groups.get(key).push(r);
        });
        for (const [k, arr] of groups.entries()) {
          arr.sort((x,y) => (x.side==='home'? -1: 1));
          groups.set(k, arr.slice(0,2));
        }
        return groups;
      }

      function twoLineCell(lines) { return `<div class=\"row2\">${lines.map(l=>`<div>${l}</div>`).join('')}</div>`; }
      function bookTwoLines(rows, book) {
        const sideVal = (r) => ((r.books||{})[book]||{})[r.side||'home'] ?? '';
        const lines = rows.map(r => sideVal(r));
        const highlight = rows.some(r => typeof r.best === 'string' && r.best.startsWith(book + ' '));
        const cls = highlight ? 'cell-odds highlight fade-enter' : 'cell-odds fade-enter';
        return `<div class=\"${cls}\">${lines.map(v=>`<div>${v}</div>`).join('')}</div>`;
      }

      const currentLinks = new Set();

      function renderData(data) {
        const markets = ['moneyline','spread','total'];
        markets.forEach(market => {
          const tbody = document.querySelector(`#tbl-${market} tbody`);
          if (!tbody) return;
          const groups = groupByMatchup(data.rows || [], market);
          const newRows = [];
          for (const [, rows] of groups.entries()) {
            if (rows.length < 1) continue;
            const top = rows[0]||{}; const bot = rows[1]||{};
            const mktLabel = (top.market||'').toLowerCase().startsWith('money') ? 'ML' : (top.market||'');
            const lineLabel = top.line ? ` · ${top.line}` : '';
            const matchupHtml = `
              <div class=\"matchup\">
                <div class=\"line\"><span class=\"team\">${top.team||''}</span><span class=\"sub\">${(top.sport||'').toUpperCase()} · ${mktLabel}${lineLabel}</span></div>
                <div class=\"line\"><span class=\"team\">${bot.team||''}</span><span class=\"sub\">${(bot.sport||'').toUpperCase()} · ${mktLabel}${lineLabel}</span></div>
              </div>`;
            const bestHtml = twoLineCell(rows.map(r => r.best || ''));
            const avgHtml = twoLineCell(rows.map(r => (r.avg ?? '')));
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td class=\"matchup\">${matchupHtml}</td>
              <td class=\"mono\">${bestHtml}</td>
              <td class=\"mono\">${avgHtml}</td>
              ${booksOrder.map(b => `<td class=\"book\">${bookTwoLines(rows,b)}</td>`).join('')}
            `;
            newRows.push(tr);
            if (top.ptoUrl) currentLinks.add(top.ptoUrl);
          }
          tbody.replaceChildren(...newRows);
        });
      }

      function openLinks(cmd) {
        const links = Array.from(currentLinks);
        if (!links.length) return;
        fetch('/open', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({cmd, links})});
      }

      async function loadSelections() {
        try {
          const r = await fetch('/selections', { cache: 'no-store' });
          const j = await r.json();
          const arr = (j.selections || []).map(s => s.toUpperCase());
          document.getElementById('activeSel').textContent = 'Active: ' + (arr.length ? arr.join(', ') : '-');
        } catch {}
      }

      document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('btn-chrome').onclick = () => openLinks('chrome');
        document.getElementById('btn-firefox').onclick = () => openLinks('firefox');
        document.getElementById('btn-comet').onclick = () => openLinks('comet');
        document.getElementById('btn-change').onclick = async () => {
          try { await fetch('/select', { method: 'POST' }); } catch {}
          // retry a few times to catch the save timing
          setTimeout(loadSelections, 1000);
          setTimeout(loadSelections, 2500);
          setTimeout(loadSelections, 5000);
        };
        loadSelections();
        // Keep header in sync if user changes selections later
        setInterval(loadSelections, 4000);
      });

      function connectSSE() {
        try {
          const es = new EventSource('/events');
          es.onmessage = (e) => {
            try { renderData(JSON.parse(e.data)); } catch {}
          };
          es.onerror = () => { es.close(); setTimeout(connectSSE, 1500); };
        } catch (e) {
          setTimeout(connectSSE, 1500);
        }
      }

      fetch('output.json', { cache: 'no-store' }).then(r=>r.json()).then(renderData).catch(()=>{});
      connectSSE();
    </script>
  </body>
</html>

